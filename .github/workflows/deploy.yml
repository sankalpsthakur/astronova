name: Deploy

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production

jobs:
  # Build and test before deployment
  pre-deploy-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd server
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r tests/requirements-test.txt

      - name: Run tests
        run: |
          cd server
          pytest tests/ -v --tb=short \
            --ignore=tests/test_performance.py \
            --ignore=tests/test_binary_responses.py \
            -k "not test_ephemeris_service_matches_swisseph"
        env:
          FLASK_ENV: testing
          SECRET_KEY: test-secret-key-for-ci

      - name: Check code quality
        run: |
          cd server
          pip install flake8 black
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=.venv,venv
          black --check . --exclude='/(\.venv|venv)/' || true
        continue-on-error: true

  # Deploy to staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://astronova-staging.onrender.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Render (Staging)
        run: |
          echo "Deploying to staging environment..."
          # Add your Render deployment command here
          # Example: curl -X POST https://api.render.com/deploy/...
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

      - name: Wait for deployment
        run: |
          echo "Running post-deploy verification for staging..."
          bash scripts/deploy-post-push-check.sh --base-url https://astronova-staging.onrender.com --wait-seconds 300 --health-retries 30 --health-delay 10

      - name: Notify deployment success
        if: success()
        run: |
          echo "Staging deployment successful!"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "Staging deployment failed!"

  # Deploy to production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://astronova.onrender.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify tag format
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Deploying tag: $TAG"
          if ! [[ $TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid tag format. Expected v*.*.* (e.g., v1.0.0)"
            exit 1
          fi

      - name: Create deployment backup
        run: |
          echo "Creating backup of current production state..."
          # Add backup commands here

      - name: Deploy to Render (Production)
        run: |
          echo "Deploying to production environment..."
          # Add your Render deployment command here
          # Example: curl -X POST https://api.render.com/deploy/...
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

      - name: Wait for deployment
        run: |
          echo "Running post-deploy verification for production..."
          bash scripts/deploy-post-push-check.sh --base-url https://astronova.onrender.com --wait-seconds 300 --health-retries 30 --health-delay 10

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: Notify deployment success
        if: success()
        run: |
          echo "Production deployment successful!"
          # Add Slack/Discord notification here if needed

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Production deployment failed! Consider rollback."
          # Add rollback commands here

  # Post-deployment monitoring
  post-deploy-monitor:
    name: Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')

    steps:
      - name: Monitor logs
        run: |
          echo "Monitoring deployment for the next 5 minutes..."
          # Add log monitoring commands here
          sleep 30

      - name: Check error rates
        run: |
          echo "Checking error rates..."
          # Add error rate checking commands here

      - name: Performance check
        run: |
          echo "Checking performance metrics..."
          # Add performance checking commands here
